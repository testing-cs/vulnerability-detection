import json
import pdb
import argparse
import numpy as np
import random


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--data_root", default="devign", type=str,
                        help="The root path of the dataset.")
    parser.add_argument("--project_name", default="qemu", type=str,
                        help="The name of the project.")
    args = parser.parse_args()
    args.train_data_file = f'../{args.data_root}/{args.project_name}_train.jsonl'

    sec_count = 0
    vul_count = 0
    vul_data = []
    with open(args.train_data_file) as rf:
        for i, line in enumerate(rf):
            item = json.loads(line.strip())
            if item['target'] == 0:
                sec_count += 1
            else:
                vul_count += 1
                vul_data.append(item)
    print(f"sec: {sec_count}, vul: {vul_count}")
    index_du = random.choices(np.arange(vul_count), k=sec_count-vul_count)
    index = 0
    with open(f"../{args.data_root}/{args.project_name}_train_du.jsonl", "w") as wf:
        for id in index_du:
            js = vul_data[id]
            wf.write(json.dumps(js) + '\n')
            index += 1
    print(index+vul_count)


if __name__ == "__main__":
    main()
